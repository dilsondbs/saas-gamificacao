<?php

require __DIR__.'/vendor/autoload.php';

$app = require_once __DIR__.'/bootstrap/app.php';
$kernel = $app->make('Illuminate\Contracts\Console\Kernel');
$kernel->bootstrap();

use Illuminate\Http\UploadedFile;
use Illuminate\Http\Request;
use App\Http\Controllers\EduAIController;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Facades\Auth;

echo "\n";
echo "===========================================\n";
echo "   TESTE UPLOAD REAL - PDF TO CURSO\n";
echo "===========================================\n\n";

// Verificar se o PDF existe
$pdfPath = storage_path('app/pdfs/nocoes-direito.pdf');

if (!file_exists($pdfPath)) {
    echo "‚ùå PDF n√£o encontrado: {$pdfPath}\n";
    echo "   Crie o arquivo primeiro.\n\n";
    exit(1);
}

$pdfName = basename($pdfPath);
echo "üì§ Enviando PDF: {$pdfName}\n";
echo "üìç Endpoint: POST /eduai/generate-course-from-file\n";
echo "üìä Tamanho: " . number_format(filesize($pdfPath) / 1024, 2) . " KB\n\n";

// Limpar logs antigos para facilitar an√°lise
$logPath = storage_path('logs/laravel.log');
$logSizeBefore = file_exists($logPath) ? filesize($logPath) : 0;

echo "‚è≥ Aguardando resposta...\n\n";

// Criar arquivo tempor√°rio para simular upload
$tempFile = tmpfile();
$tempPath = stream_get_meta_data($tempFile)['uri'];
copy($pdfPath, $tempPath);

// Criar UploadedFile fake
$uploadedFile = new UploadedFile(
    $tempPath,
    $pdfName,
    'application/pdf',
    null,
    true // test mode
);

// Buscar usu√°rio real do banco de dados
$user = \App\Models\User::first();
$userWasCreated = false;

// Se n√£o existir usu√°rio, criar um
if (!$user) {
    echo "‚ö†Ô∏è  Nenhum usu√°rio encontrado. Criando usu√°rio de teste...\n";
    $user = \App\Models\User::create([
        'name' => 'Teste Dual Brain',
        'email' => 'teste@dualbrain.com',
        'password' => bcrypt('password123'),
        'role' => 'instructor',
        'tenant_id' => 'test_tenant_' . time()
    ]);
    $userWasCreated = true;
    echo "‚úÖ Usu√°rio criado: {$user->email}\n\n";
} else {
    echo "‚úÖ Usando usu√°rio existente: {$user->email}\n\n";
}

// Autenticar com usu√°rio real
Auth::login($user);

// Criar request fake
$request = Request::create('/eduai/generate-course-from-file', 'POST', [
    'title' => 'No√ß√µes de Direito para Militares',
    'target_audience' => 'Militares em forma√ß√£o',
    'difficulty' => 'beginner'
]);

$request->files->set('file', $uploadedFile);

// Iniciar cron√¥metro
$startTime = microtime(true);

try {
    // Instanciar controller e chamar m√©todo
    $geminiService = app(\App\Services\GeminiAIService::class);
    $dualBrainService = app(\App\Services\GeminiDualBrainService::class);
    $controller = new EduAIController($geminiService, $dualBrainService);

    // Executar gera√ß√£o
    $response = $controller->generateCourseFromFile($request);

    $endTime = microtime(true);
    $totalTime = $endTime - $startTime;

    // Obter dados da resposta
    $responseData = json_decode($response->getContent(), true);
    $statusCode = $response->getStatusCode();

    echo "===========================================\n";
    echo "‚úÖ RESPOSTA RECEBIDA\n";
    echo "===========================================\n";
    echo "Status: {$statusCode} " . ($statusCode === 200 ? 'OK' : 'ERROR') . "\n";
    echo "Tempo Total: " . number_format($totalTime, 2) . "s\n";

    if (isset($responseData['courseData']['saved_course_id'])) {
        echo "Curso ID: " . $responseData['courseData']['saved_course_id'] . "\n";
    }

    echo "\n";

    // Analisar logs
    echo "üìä VERIFICANDO LOGS...\n";
    echo "-------------------------------------------\n";

    // Ler logs novos (apenas o que foi adicionado)
    if (file_exists($logPath)) {
        $logContent = file_get_contents($logPath);
        $newLogs = substr($logContent, $logSizeBefore);

        // Buscar marcadores importantes
        $usedDualBrain = strpos($newLogs, '[Controller] Tentando Dual Brain') !== false;
        $dualBrainSuccess = strpos($newLogs, '[Controller] Dual Brain sucesso') !== false;
        $dualBrainFailed = strpos($newLogs, '[Controller] Dual Brain falhou') !== false;
        $usedFallback = strpos($newLogs, 'usando m√©todo antigo') !== false;

        // Extrair tempos do Dual Brain
        $analysisTime = null;
        $generationTime = null;

        if (preg_match('/Etapa 1: An√°lise.*?(\d+\.\d+)s/', $newLogs, $matches)) {
            $analysisTime = $matches[1];
        }

        if (preg_match('/Etapa 2: Gera√ß√£o.*?(\d+\.\d+)s/', $newLogs, $matches)) {
            $generationTime = $matches[1];
        }

        // Exibir logs formatados
        if ($usedDualBrain) {
            echo "‚úÖ [Controller] Tentando Dual Brain...\n";

            if ($analysisTime) {
                echo "‚úÖ [Dual Brain] Etapa 1: An√°lise - {$analysisTime}s\n";
            }

            if ($generationTime) {
                echo "‚úÖ [Dual Brain] Etapa 2: Gera√ß√£o - {$generationTime}s\n";
            }

            if ($dualBrainSuccess) {
                echo "‚úÖ [Controller] Dual Brain sucesso!\n";
            } elseif ($dualBrainFailed) {
                echo "‚ö†Ô∏è  [Controller] Dual Brain falhou\n";
            }
        }

        echo "\n";

        // Resultado
        echo "üéØ M√âTODO USADO: ";
        if ($dualBrainSuccess) {
            echo "Dual Brain ‚úÖ\n";
            echo "‚ùå Fallback N√ÉO foi necess√°rio\n";
        } elseif ($usedFallback) {
            echo "M√©todo Antigo (Fallback) ‚ö†Ô∏è\n";
            echo "‚ö†Ô∏è  Dual Brain falhou ou n√£o executou\n";
        } else {
            echo "Desconhecido ‚ùì\n";
        }

        echo "\n";

        // Performance comparison
        if ($analysisTime && $generationTime && $dualBrainSuccess) {
            echo "‚è±Ô∏è  PERFORMANCE DUAL BRAIN:\n";
            echo "-------------------------------------------\n";
            echo "An√°lise (Gemini 2.5):     {$analysisTime}s\n";
            echo "Gera√ß√£o (Gemini 1.5 Pro): {$generationTime}s\n";
            $dualBrainTotal = floatval($analysisTime) + floatval($generationTime);
            echo "Subtotal Dual Brain:      " . number_format($dualBrainTotal, 2) . "s\n";
            echo "Overhead (processamento): " . number_format($totalTime - $dualBrainTotal, 2) . "s\n";
            echo "\n";
        }
    }

    // Estrutura do curso
    if ($statusCode === 200 && isset($responseData['courseData'])) {
        $courseData = $responseData['courseData'];

        echo "üì¶ ESTRUTURA DO CURSO:\n";
        echo "-------------------------------------------\n";
        echo "T√≠tulo: " . ($courseData['title'] ?? 'N/A') . "\n";
        echo "Descri√ß√£o: " . substr($courseData['description'] ?? 'N/A', 0, 100) . "...\n";
        echo "Dificuldade: " . ($courseData['difficulty'] ?? 'N/A') . "\n";

        $modulesCount = count($courseData['modules'] ?? []);
        $lessonsCount = 0;

        foreach ($courseData['modules'] ?? [] as $module) {
            $lessonsCount += count($module['lessons'] ?? []);
        }

        echo "M√≥dulos: {$modulesCount}\n";
        echo "Li√ß√µes: {$lessonsCount}\n";
        echo "Pontos: " . ($courseData['points_per_completion'] ?? 'N/A') . "\n";
        echo "\n";

        // Detalhar m√≥dulos
        echo "üìö M√ìDULOS:\n";
        echo "-------------------------------------------\n";
        foreach ($courseData['modules'] ?? [] as $index => $module) {
            echo "M√≥dulo " . ($index + 1) . ": " . ($module['title'] ?? 'N/A') . "\n";
            echo "  ‚îî‚îÄ " . count($module['lessons'] ?? []) . " li√ß√µes\n";

            // Primeiras 2 li√ß√µes
            $lessons = array_slice($module['lessons'] ?? [], 0, 2);
            foreach ($lessons as $lIndex => $lesson) {
                echo "     ‚îî‚îÄ " . ($lesson['title'] ?? 'N/A') . " (" . ($lesson['type'] ?? 'N/A') . ")\n";
            }

            if (count($module['lessons'] ?? []) > 2) {
                echo "     ‚îî‚îÄ ... +" . (count($module['lessons']) - 2) . " mais\n";
            }
            echo "\n";
        }

        // Salvar JSON completo
        $outputFile = storage_path('app/test_output_course.json');
        file_put_contents($outputFile, json_encode($courseData, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE));
        echo "üíæ JSON completo salvo em: {$outputFile}\n\n";
    }

    echo "===========================================\n";
    if ($statusCode === 200 && $dualBrainSuccess) {
        echo "‚úÖ TESTE COMPLETO COM SUCESSO!\n";
        echo "   Dual Brain funcionou perfeitamente!\n";
    } elseif ($statusCode === 200) {
        echo "‚ö†Ô∏è  TESTE COMPLETO COM AVISOS\n";
        echo "   Curso gerado, mas usando fallback\n";
    } else {
        echo "‚ùå TESTE FALHOU\n";
        echo "   Erro: " . ($responseData['message'] ?? 'Desconhecido') . "\n";
    }
    echo "===========================================\n\n";

    // Mostrar logs completos se houver erro
    if ($statusCode !== 200) {
        echo "üìã LOGS DE ERRO:\n";
        echo "-------------------------------------------\n";
        echo substr($newLogs, -2000) . "\n";
        echo "-------------------------------------------\n\n";
    }

} catch (\Exception $e) {
    $endTime = microtime(true);
    $totalTime = $endTime - $startTime;

    echo "===========================================\n";
    echo "‚ùå EXCE√á√ÉO CAPTURADA\n";
    echo "===========================================\n";
    echo "Tempo at√© erro: " . number_format($totalTime, 2) . "s\n";
    echo "Mensagem: " . $e->getMessage() . "\n";
    echo "Arquivo: " . $e->getFile() . "\n";
    echo "Linha: " . $e->getLine() . "\n\n";

    echo "Stack Trace:\n";
    echo $e->getTraceAsString() . "\n\n";

    echo "===========================================\n\n";
} finally {
    // Limpar arquivo tempor√°rio
    if (isset($tempFile)) {
        fclose($tempFile);
    }

    // Cleanup: deletar usu√°rio de teste se foi criado
    if (isset($userWasCreated) && $userWasCreated && isset($user) && $user->email === 'teste@dualbrain.com') {
        echo "üßπ Limpando: Deletando usu√°rio de teste...\n";
        try {
            $user->delete();
            echo "‚úÖ Usu√°rio de teste deletado\n\n";
        } catch (\Exception $e) {
            echo "‚ö†Ô∏è  N√£o foi poss√≠vel deletar usu√°rio: " . $e->getMessage() . "\n\n";
        }
    }
}
